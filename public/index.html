<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weekly Task Manager</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 30px;
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 20px;
            font-size: 2em;
        }

        .add-task-section {
            background: #f0f4ff;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
            border: 2px solid #667eea;
        }

        .add-task-section h2 {
            color: #333;
            font-size: 1.2em;
            margin-bottom: 15px;
        }

        .add-task-form {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .add-task-form input {
            flex: 1;
            min-width: 250px;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 1em;
        }

        .add-task-form button {
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.3s;
        }

        .add-task-form button:hover {
            background: #5568d3;
        }

        .days-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .day-column {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            min-height: 150px;
        }

        .day-header {
            font-weight: bold;
            font-size: 1.1em;
            color: #667eea;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid #667eea;
        }

        .task-pool-section {
            background: #fff9e6;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
            border: 2px solid #ffd700;
        }

        .task-pool-header h2 {
            color: #333;
            font-size: 1.3em;
            margin-bottom: 15px;
        }

        #taskPool {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }

        .task-item {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 10px;
            cursor: move;
            transition: all 0.3s;
        }

        .task-item:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        .task-item.dragging {
            opacity: 0.5;
        }

        .task-item.drag-over-item {
            border-top: 3px solid #2196F3;
        }

        .task-content {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .task-text-row {
            display: flex;
            align-items: center;
            gap: 10px;
            width: 100%;
        }

        .task-actions-row {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .task-text {
            flex: 1;
            font-size: 1em;
            color: #333;
            word-break: break-word;
        }

        .task-text-input {
            flex: 1;
            padding: 8px;
            border: 2px solid #667eea;
            border-radius: 4px;
            font-size: 1em;
        }

        .task-checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
            flex-shrink: 0;
        }

        .edit-btn, .save-btn {
            background: #ff9800;
            color: white;
            border: none;
            padding: 3px 6px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.75em;
            transition: background 0.3s;
            flex-shrink: 0;
        }

        .edit-btn:hover, .save-btn:hover {
            background: #f57c00;
        }

        .save-btn {
            background: #4CAF50;
        }

        .save-btn:hover {
            background: #45a049;
        }

        .recycle-btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background 0.3s;
            flex-shrink: 0;
        }

        .recycle-btn:hover {
            background: #45a049;
        }

        .day-buttons {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }

        .day-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85em;
            font-weight: bold;
            transition: background 0.3s;
        }

        .day-btn:hover {
            background: #5568d3;
        }

        .delete-btn {
            background: #f44336;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85em;
            transition: background 0.3s;
        }

        .delete-btn:hover {
            background: #da190b;
        }

        .arrow-btn {
            background: #9e9e9e;
            color: white;
            border: none;
            padding: 3px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85em;
            transition: background 0.3s;
            flex-shrink: 0;
        }

        .arrow-btn:hover {
            background: #757575;
        }

        .arrow-btn:disabled {
            background: #e0e0e0;
            cursor: not-allowed;
        }

        .completed-section {
            background: #e8f5e9;
            border-radius: 8px;
            padding: 20px;
            border: 2px solid #4CAF50;
        }

        .completed-section h2 {
            color: #2e7d32;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .task-item.completed .task-text {
            text-decoration: line-through;
            color: #666;
        }

        .drag-over {
            background: #e3f2fd;
            border-color: #2196F3;
        }

        .error-banner {
            background: #ffebee;
            border: 2px solid #f44336;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            color: #c62828;
        }

        @media (max-width: 768px) {
            .days-grid {
                grid-template-columns: 1fr;
            }
            
            #taskPool {
                grid-template-columns: 1fr;
            }

            .container {
                padding: 15px;
            }

            h1 {
                font-size: 1.5em;
            }

            .add-task-form {
                flex-direction: column;
            }

            .add-task-form input {
                min-width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸ“… DannyDo</h1>
        <div id="errorBanner"></div>

        <!-- Add Task Section (at top) -->
        <div class="add-task-section">
            <h2>âž• Add New Task</h2>
            <div class="add-task-form">
                <input type="text" id="newTaskInput" placeholder="Enter a new task..." />
            </div>
            <div class="day-buttons" id="addTaskDayButtons">
                <button class="day-btn" onclick="addTaskToDay('pool')">Task Pool</button>
                <button class="day-btn" onclick="addTaskToDay('monday')">Monday</button>
                <button class="day-btn" onclick="addTaskToDay('tuesday')">Tuesday</button>
                <button class="day-btn" onclick="addTaskToDay('wednesday')">Wednesday</button>
                <button class="day-btn" onclick="addTaskToDay('thursday')">Thursday</button>
                <button class="day-btn" onclick="addTaskToDay('friday')">Friday</button>
                <button class="day-btn" onclick="addTaskToDay('saturday')">Saturday</button>
                <button class="day-btn" onclick="addTaskToDay('sunday')">Sunday</button>
            </div>
        </div>

        <!-- Day Columns -->
        <div class="days-grid" id="daysGrid">
            <div class="day-column" data-day="monday">
                <div class="day-header">Monday</div>
                <div class="day-tasks" id="monday-tasks"></div>
            </div>
            <div class="day-column" data-day="tuesday">
                <div class="day-header">Tuesday</div>
                <div class="day-tasks" id="tuesday-tasks"></div>
            </div>
            <div class="day-column" data-day="wednesday">
                <div class="day-header">Wednesday</div>
                <div class="day-tasks" id="wednesday-tasks"></div>
            </div>
            <div class="day-column" data-day="thursday">
                <div class="day-header">Thursday</div>
                <div class="day-tasks" id="thursday-tasks"></div>
            </div>
            <div class="day-column" data-day="friday">
                <div class="day-header">Friday</div>
                <div class="day-tasks" id="friday-tasks"></div>
            </div>
            <div class="day-column" data-day="saturday">
                <div class="day-header">Saturday</div>
                <div class="day-tasks" id="saturday-tasks"></div>
            </div>
            <div class="day-column" data-day="sunday">
                <div class="day-header">Sunday</div>
                <div class="day-tasks" id="sunday-tasks"></div>
            </div>
        </div>

        <!-- Task Pool -->
        <div class="task-pool-section">
            <div class="task-pool-header">
                <h2>ðŸ“‹ Task Pool</h2>
            </div>
            <div id="taskPool"></div>
        </div>

        <!-- Completed Tasks -->
        <div class="completed-section">
            <h2>âœ… Completed Tasks</h2>
            <div id="completedTasks"></div>
        </div>
    </div>

    <script>
        const API_URL = '/api';
        let tasks = [];
        let draggedTaskId = null;
        let draggedOverTaskId = null;
        let editingTaskId = null;

        // Show error banner
        function showError(message) {
            const banner = document.getElementById('errorBanner');
            banner.className = 'error-banner';
            banner.textContent = 'âš ï¸ ' + message;
            setTimeout(() => {
                banner.textContent = '';
                banner.className = '';
            }, 5000);
        }

        // Load tasks from API
        async function loadTasks() {
            try {
                const response = await fetch(`${API_URL}/tasks`);
                if (!response.ok) throw new Error('Failed to load tasks');
                tasks = await response.json();
                renderAllTasks();
            } catch (error) {
                console.error('Error loading tasks:', error);
                showError('Failed to load tasks. Please refresh the page.');
            }
        }

        // Add new task to specific day
        async function addTaskToDay(day) {
            const input = document.getElementById('newTaskInput');
            const text = input.value.trim();
            
            if (text === '') return;

            try {
                const position = tasks.filter(t => t.day === day).length;
                const response = await fetch(`${API_URL}/tasks`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        text: text,
                        day: day,
                        completed: 0,
                        position: position
                    })
                });

                if (!response.ok) throw new Error('Failed to create task');
                
                const newTask = await response.json();
                tasks.push(newTask);
                input.value = '';
                renderAllTasks();
            } catch (error) {
                console.error('Error creating task:', error);
                showError('Failed to create task. Please try again.');
            }
        }

        // Update task
        async function updateTask(taskId, updates) {
            try {
                const response = await fetch(`${API_URL}/tasks/${taskId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(updates)
                });

                if (!response.ok) throw new Error('Failed to update task');
                
                const taskIndex = tasks.findIndex(t => t.id === taskId);
                if (taskIndex !== -1) {
                    tasks[taskIndex] = { ...tasks[taskIndex], ...updates };
                }
                
                renderAllTasks();
            } catch (error) {
                console.error('Error updating task:', error);
                showError('Failed to update task. Please try again.');
            }
        }

        // Move task to day
        async function moveToDay(taskId, day) {
            await updateTask(taskId, { day: day, completed: 0 });
        }

        // Recycle task back to pool
        async function recycleTask(taskId) {
            await updateTask(taskId, { day: 'pool', completed: 0 });
        }

        // Toggle task completion
        async function toggleComplete(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (task) {
                const newCompleted = task.completed ? 0 : 1;
                const newDay = newCompleted ? 'completed' : task.day;
                await updateTask(taskId, { completed: newCompleted, day: newDay });
            }
        }

        // Delete task
        async function deleteTask(taskId) {
            if (!confirm('Are you sure you want to delete this task?')) return;
            
            try {
                const response = await fetch(`${API_URL}/tasks/${taskId}`, {
                    method: 'DELETE'
                });

                if (!response.ok) throw new Error('Failed to delete task');
                
                tasks = tasks.filter(t => t.id !== taskId);
                renderAllTasks();
            } catch (error) {
                console.error('Error deleting task:', error);
                showError('Failed to delete task. Please try again.');
            }
        }

        // Start editing task
        function startEdit(taskId) {
            editingTaskId = taskId;
            renderAllTasks();
        }

        // Save edited task
        async function saveEdit(taskId) {
            const inputElement = document.querySelector(`input[data-edit-id="${taskId}"]`);
            if (inputElement) {
                const newText = inputElement.value.trim();
                if (newText) {
                    await updateTask(taskId, { text: newText });
                }
            }
            editingTaskId = null;
        }

        // Cancel editing
        function cancelEdit() {
            editingTaskId = null;
            renderAllTasks();
        }

        // Move task up in order
        async function moveTaskUp(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;

            const sameDayTasks = tasks
                .filter(t => t.day === task.day && t.day !== 'pool' && t.day !== 'completed')
                .sort((a, b) => a.position - b.position);
            
            const currentIndex = sameDayTasks.findIndex(t => t.id === taskId);
            if (currentIndex <= 0) return; // Already at top

            // Swap positions with task above
            const taskAbove = sameDayTasks[currentIndex - 1];
            await updateTask(task.id, { position: taskAbove.position });
            await updateTask(taskAbove.id, { position: task.position });
        }

        // Move task down in order
        async function moveTaskDown(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;

            const sameDayTasks = tasks
                .filter(t => t.day === task.day && t.day !== 'pool' && t.day !== 'completed')
                .sort((a, b) => a.position - b.position);
            
            const currentIndex = sameDayTasks.findIndex(t => t.id === taskId);
            if (currentIndex < 0 || currentIndex >= sameDayTasks.length - 1) return; // Already at bottom

            // Swap positions with task below
            const taskBelow = sameDayTasks[currentIndex + 1];
            await updateTask(task.id, { position: taskBelow.position });
            await updateTask(taskBelow.id, { position: task.position });
        }

        // Render a single task
        function renderTask(task) {
            const div = document.createElement('div');
            div.className = 'task-item' + (task.completed ? ' completed' : '');
            div.draggable = true;
            div.dataset.taskId = task.id;
            div.ondragstart = dragStart;
            div.ondragend = dragEnd;
            div.ondragover = dragOver;
            div.ondragleave = dragLeaveTask;

            const contentDiv = document.createElement('div');
            contentDiv.className = 'task-content';

            // Text row with edit button
            const textRow = document.createElement('div');
            textRow.className = 'task-text-row';

            // Task text or input
            if (editingTaskId === task.id) {
                const input = document.createElement('input');
                input.type = 'text';
                input.className = 'task-text-input';
                input.value = task.text;
                input.dataset.editId = task.id;
                input.onkeypress = (e) => {
                    if (e.key === 'Enter') saveEdit(task.id);
                    if (e.key === 'Escape') cancelEdit();
                };
                textRow.appendChild(input);

                const saveBtn = document.createElement('button');
                saveBtn.className = 'save-btn';
                saveBtn.innerHTML = 'âœ“';
                saveBtn.onclick = () => saveEdit(task.id);
                textRow.appendChild(saveBtn);

                setTimeout(() => input.focus(), 0);
            } else {
                const textSpan = document.createElement('span');
                textSpan.className = 'task-text';
                textSpan.textContent = task.text;
                textRow.appendChild(textSpan);

                // Edit button
                const editBtn = document.createElement('button');
                editBtn.className = 'edit-btn';
                editBtn.innerHTML = 'âœï¸';
                editBtn.onclick = (e) => {
                    e.stopPropagation();
                    startEdit(task.id);
                };
                textRow.appendChild(editBtn);
            }

            contentDiv.appendChild(textRow);

            // Actions row (checkbox, recycle, day buttons, delete)
            const actionsRow = document.createElement('div');
            actionsRow.className = 'task-actions-row';

            // Checkbox and recycle for scheduled tasks
            if (task.day !== 'pool' && task.day !== 'completed') {
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'task-checkbox';
                checkbox.checked = task.completed;
                checkbox.onchange = () => toggleComplete(task.id);
                actionsRow.appendChild(checkbox);

                const recycleBtn = document.createElement('button');
                recycleBtn.className = 'recycle-btn';
                recycleBtn.innerHTML = 'â™»ï¸';
                recycleBtn.onclick = () => recycleTask(task.id);
                actionsRow.appendChild(recycleBtn);

                // Arrow buttons for reordering
                const sameDayTasks = tasks
                    .filter(t => t.day === task.day && t.day !== 'pool' && t.day !== 'completed')
                    .sort((a, b) => a.position - b.position);
                const currentIndex = sameDayTasks.findIndex(t => t.id === task.id);

                const upBtn = document.createElement('button');
                upBtn.className = 'arrow-btn';
                upBtn.innerHTML = 'â–²';
                upBtn.onclick = () => moveTaskUp(task.id);
                upBtn.disabled = currentIndex === 0;
                actionsRow.appendChild(upBtn);

                const downBtn = document.createElement('button');
                downBtn.className = 'arrow-btn';
                downBtn.innerHTML = 'â–¼';
                downBtn.onclick = () => moveTaskDown(task.id);
                downBtn.disabled = currentIndex === sameDayTasks.length - 1;
                actionsRow.appendChild(downBtn);
            }

            // Day buttons for pool tasks
            if (task.day === 'pool') {
                const buttonsContainer = document.createElement('div');
                buttonsContainer.className = 'day-buttons';

                const days = [
                    { name: 'Mo', value: 'monday' },
                    { name: 'Tu', value: 'tuesday' },
                    { name: 'We', value: 'wednesday' },
                    { name: 'Th', value: 'thursday' },
                    { name: 'Fr', value: 'friday' },
                    { name: 'Sa', value: 'saturday' },
                    { name: 'Su', value: 'sunday' }
                ];

                days.forEach(day => {
                    const btn = document.createElement('button');
                    btn.className = 'day-btn';
                    btn.textContent = day.name;
                    btn.onclick = () => moveToDay(task.id, day.value);
                    buttonsContainer.appendChild(btn);
                });

                actionsRow.appendChild(buttonsContainer);

                // Add delete button for pool tasks
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'delete-btn';
                deleteBtn.textContent = 'Delete';
                deleteBtn.onclick = () => deleteTask(task.id);
                actionsRow.appendChild(deleteBtn);
            }

            // Day buttons for scheduled tasks (not pool, not completed)
            if (task.day !== 'pool' && task.day !== 'completed') {
                const buttonsContainer = document.createElement('div');
                buttonsContainer.className = 'day-buttons';

                const days = [
                    { name: 'Mo', value: 'monday' },
                    { name: 'Tu', value: 'tuesday' },
                    { name: 'We', value: 'wednesday' },
                    { name: 'Th', value: 'thursday' },
                    { name: 'Fr', value: 'friday' },
                    { name: 'Sa', value: 'saturday' },
                    { name: 'Su', value: 'sunday' }
                ];

                days.forEach(day => {
                    const btn = document.createElement('button');
                    btn.className = 'day-btn';
                    btn.textContent = day.name;
                    btn.onclick = () => moveToDay(task.id, day.value);
                    buttonsContainer.appendChild(btn);
                });

                actionsRow.appendChild(buttonsContainer);
            }

            // Day buttons and delete for completed tasks
            if (task.day === 'completed') {
                const buttonsContainer = document.createElement('div');
                buttonsContainer.className = 'day-buttons';

                const days = [
                    { name: 'Mo', value: 'monday' },
                    { name: 'Tu', value: 'tuesday' },
                    { name: 'We', value: 'wednesday' },
                    { name: 'Th', value: 'thursday' },
                    { name: 'Fr', value: 'friday' },
                    { name: 'Sa', value: 'saturday' },
                    { name: 'Su', value: 'sunday' }
                ];

                days.forEach(day => {
                    const btn = document.createElement('button');
                    btn.className = 'day-btn';
                    btn.textContent = day.name;
                    btn.onclick = () => moveToDay(task.id, day.value);
                    buttonsContainer.appendChild(btn);
                });

                actionsRow.appendChild(buttonsContainer);

                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'delete-btn';
                deleteBtn.textContent = 'Delete';
                deleteBtn.onclick = () => deleteTask(task.id);
                actionsRow.appendChild(deleteBtn);
            }

            contentDiv.appendChild(actionsRow);
            div.appendChild(contentDiv);

            return div;
        }

        // Render all tasks
        function renderAllTasks() {
            document.getElementById('taskPool').innerHTML = '';
            document.getElementById('completedTasks').innerHTML = '';
            document.querySelectorAll('.day-tasks').forEach(el => el.innerHTML = '');

            // Sort pool tasks alphabetically
            const poolTasks = tasks.filter(t => t.day === 'pool').sort((a, b) => 
                a.text.toLowerCase().localeCompare(b.text.toLowerCase())
            );

            // Other tasks by position
            const dayTasks = tasks
                .filter(t => t.day !== 'pool' && t.day !== 'completed')
                .sort((a, b) => a.position - b.position);
            const completedTasks = tasks.filter(t => t.day === 'completed');

            // Render pool tasks
            poolTasks.forEach(task => {
                const taskElement = renderTask(task);
                document.getElementById('taskPool').appendChild(taskElement);
            });

            // Render day tasks
            dayTasks.forEach(task => {
                const taskElement = renderTask(task);
                const dayContainer = document.getElementById(`${task.day}-tasks`);
                if (dayContainer) {
                    dayContainer.appendChild(taskElement);
                }
            });

            // Render completed tasks
            completedTasks.forEach(task => {
                const taskElement = renderTask(task);
                document.getElementById('completedTasks').appendChild(taskElement);
            });
        }

        // Drag and drop for day columns
        function dragStart(e) {
            draggedTaskId = parseInt(e.target.dataset.taskId);
            e.target.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
        }

        function dragEnd(e) {
            e.target.classList.remove('dragging');
            document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
            document.querySelectorAll('.drag-over-item').forEach(el => el.classList.remove('drag-over-item'));
            draggedOverTaskId = null;
        }

        // Drag over tasks within same day (for reordering)
        function dragOver(e) {
            e.preventDefault();
            const target = e.target.closest('.task-item');
            if (target && target.dataset.taskId) {
                const targetTaskId = parseInt(target.dataset.taskId);
                if (targetTaskId !== draggedTaskId) {
                    draggedOverTaskId = targetTaskId;
                    document.querySelectorAll('.drag-over-item').forEach(el => el.classList.remove('drag-over-item'));
                    target.classList.add('drag-over-item');
                }
            }
        }

        function dragLeaveTask(e) {
            const target = e.target.closest('.task-item');
            if (target) {
                target.classList.remove('drag-over-item');
            }
        }

        // Drop handler - handles both moving to different day and reordering
        document.addEventListener('drop', async function(e) {
            e.preventDefault();
            
            const draggedTask = tasks.find(t => t.id === draggedTaskId);
            if (!draggedTask) return;

            // Check if dropped on a task (for reordering)
            if (draggedOverTaskId && draggedTaskId !== draggedOverTaskId) {
                const targetTask = tasks.find(t => t.id === draggedOverTaskId);
                
                if (draggedTask && targetTask && draggedTask.day === targetTask.day && targetTask.day !== 'pool' && targetTask.day !== 'completed') {
                    // Reorder within same day
                    const sameDayTasks = tasks
                        .filter(t => t.day === draggedTask.day && t.day !== 'pool' && t.day !== 'completed')
                        .sort((a, b) => a.position - b.position);
                    
                    const draggedIndex = sameDayTasks.findIndex(t => t.id === draggedTaskId);
                    const targetIndex = sameDayTasks.findIndex(t => t.id === draggedOverTaskId);
                    
                    if (draggedIndex !== -1 && targetIndex !== -1) {
                        // Remove dragged task from array
                        const [movedTask] = sameDayTasks.splice(draggedIndex, 1);
                        // Insert at target position
                        sameDayTasks.splice(targetIndex, 0, movedTask);
                        
                        // Update all positions
                        for (let i = 0; i < sameDayTasks.length; i++) {
                            const taskToUpdate = sameDayTasks[i];
                            const taskIndex = tasks.findIndex(t => t.id === taskToUpdate.id);
                            if (taskIndex !== -1) {
                                tasks[taskIndex].position = i;
                            }
                            
                            try {
                                await fetch(`${API_URL}/tasks/${taskToUpdate.id}`, {
                                    method: 'PUT',
                                    headers: {
                                        'Content-Type': 'application/json',
                                    },
                                    body: JSON.stringify({ position: i })
                                });
                            } catch (error) {
                                console.error('Error updating position:', error);
                            }
                        }
                        
                        renderAllTasks();
                    }
                }
            }
            // Check if dropped on a day column
            else {
                const column = e.target.closest('.day-column');
                if (column && draggedTaskId) {
                    const day = column.dataset.day;
                    if (day && draggedTask.day !== day) {
                        await moveToDay(draggedTaskId, day);
                    }
                }
            }
            
            document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
            document.querySelectorAll('.drag-over-item').forEach(el => el.classList.remove('drag-over-item'));
            draggedOverTaskId = null;
        });

        document.addEventListener('dragover', function(e) {
            const column = e.target.closest('.day-column');
            if (column) {
                e.preventDefault();
                column.classList.add('drag-over');
            }
        });

        document.addEventListener('dragleave', function(e) {
            const column = e.target.closest('.day-column');
            if (column && !column.contains(e.relatedTarget)) {
                column.classList.remove('drag-over');
            }
        });

        // Enter key to add task to pool
        document.getElementById('newTaskInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') addTaskToDay('pool');
        });

        // Load tasks on page load
        loadTasks();
    </script>
</body>
</html>
